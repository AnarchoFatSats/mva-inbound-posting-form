<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug User Role Issue</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Why Admin Goes to Agent Dashboard</h1>
        <p>This tool will help us figure out why admin users are being routed to the agent dashboard.</p>
        
        <button class="btn" onclick="debugLocalStorage()">Check localStorage Data</button>
        <button class="btn" onclick="fixAdminRole()">Fix Admin Role</button>
        <button class="btn success" onclick="forceAdminRedirect()">Force Admin Redirect</button>
        <button class="btn danger" onclick="clearAndRelogin()">Clear & Re-login</button>
    </div>

    <div class="container">
        <h2>Current localStorage Contents:</h2>
        <div class="debug-info" id="localStorage-debug"></div>
    </div>

    <div class="container">
        <h2>Diagnosis & Fix:</h2>
        <div id="diagnosis-results"></div>
    </div>

    <div class="container">
        <h2>Manual Admin Role Fix:</h2>
        <p>If automatic fix doesn't work, manually set the admin role:</p>
        <input type="email" id="admin-email" placeholder="Admin email (george@contentkingpins.com)" value="george@contentkingpins.com">
        <button class="btn success" onclick="manualAdminFix()">Set as Admin & Redirect</button>
    </div>

    <script>
        function showResult(message, type = 'info') {
            const results = document.getElementById('diagnosis-results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
        }

        function debugLocalStorage() {
            const debugDiv = document.getElementById('localStorage-debug');
            
            try {
                const authToken = localStorage.getItem('auth_token');
                const userString = localStorage.getItem('user');
                
                let debugInfo = `=== AUTH TOKEN ===\n`;
                debugInfo += authToken ? `‚úÖ Token exists: ${authToken.substring(0, 50)}...\n` : `‚ùå No auth token found\n`;
                
                debugInfo += `\n=== USER DATA ===\n`;
                
                if (userString) {
                    try {
                        const userData = JSON.parse(userString);
                        debugInfo += `‚úÖ User data exists:\n`;
                        debugInfo += JSON.stringify(userData, null, 2);
                        
                        debugInfo += `\n\n=== ROLE ANALYSIS ===\n`;
                        debugInfo += `userData.role: "${userData.role}"\n`;
                        debugInfo += `userData['custom:role']: "${userData['custom:role']}"\n`;
                        
                        const detectedRole = userData['custom:role'] || userData.role || 'agent';
                        debugInfo += `DETECTED ROLE: "${detectedRole}"\n`;
                        
                        if (detectedRole === 'admin') {
                            debugInfo += `‚úÖ Should redirect to admin.html\n`;
                        } else {
                            debugInfo += `‚ùå Will redirect to agent-aurora.html (PROBLEM!)\n`;
                        }
                        
                    } catch (e) {
                        debugInfo += `‚ùå Error parsing user data: ${e.message}\n`;
                        debugInfo += `Raw user string: ${userString}\n`;
                    }
                } else {
                    debugInfo += `‚ùå No user data found\n`;
                }
                
                debugDiv.textContent = debugInfo;
                
                // Also show results in diagnosis
                showResult('localStorage debug complete - check contents above');
                
            } catch (error) {
                showResult(`Error debugging localStorage: ${error.message}`, 'error');
            }
        }

        function fixAdminRole() {
            try {
                const userString = localStorage.getItem('user');
                
                if (!userString) {
                    showResult('No user data found. Please log in first.', 'error');
                    return;
                }
                
                const userData = JSON.parse(userString);
                
                // Force set admin role
                userData['custom:role'] = 'admin';
                userData.role = 'admin';
                
                // Save back to localStorage
                localStorage.setItem('user', JSON.stringify(userData));
                
                showResult('‚úÖ Admin role set! User data updated.', 'success');
                showResult(`Updated user: ${JSON.stringify(userData, null, 2)}`);
                
                // Refresh debug display
                debugLocalStorage();
                
            } catch (error) {
                showResult(`Error fixing admin role: ${error.message}`, 'error');
            }
        }

        function forceAdminRedirect() {
            showResult('üîÑ Forcing redirect to admin dashboard...', 'warning');
            
            setTimeout(() => {
                window.location.href = 'admin.html';
            }, 1000);
        }

        function clearAndRelogin() {
            if (confirm('This will clear all auth data and you will need to log in again. Continue?')) {
                localStorage.clear();
                showResult('üóëÔ∏è All auth data cleared. Redirecting to login...', 'warning');
                
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }

        function manualAdminFix() {
            const email = document.getElementById('admin-email').value;
            
            if (!email) {
                showResult('Please enter admin email', 'error');
                return;
            }
            
            // Create proper admin user object
            const adminUser = {
                email: email,
                role: 'admin',
                'custom:role': 'admin',
                'email_verified': 'true',
                'given_name': 'Admin',
                'family_name': 'User'
            };
            
            // Get existing token or create placeholder
            const existingToken = localStorage.getItem('auth_token') || 'placeholder_admin_token';
            
            // Save admin data
            localStorage.setItem('user', JSON.stringify(adminUser));
            localStorage.setItem('auth_token', existingToken);
            
            showResult('‚úÖ Manual admin role set!', 'success');
            showResult(`Admin user created: ${JSON.stringify(adminUser, null, 2)}`);
            
            setTimeout(() => {
                showResult('üîÑ Redirecting to admin dashboard...', 'success');
                window.location.href = 'admin.html';
            }, 2000);
        }

        // Auto-run debug on page load
        document.addEventListener('DOMContentLoaded', () => {
            debugLocalStorage();
        });
    </script>
</body>
</html> 