<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Connectors CRM - Login</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Amazon Cognito Identity SDK -->
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.1/dist/amazon-cognito-identity.min.js"></script>
    <!-- CryptoJS for hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0F2D40;
            --primary-light: #164967;
            --accent-color: #F5EFD9;
            --text-color: #333333;
            --text-muted: #718096;
            --bg-light: #f0f4f8;
            --bg-white: #ffffff;
            --shadow-color: rgba(15, 45, 64, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            position: relative;
            overflow: hidden;
            color: var(--text-color);
        }
        
        /* Hero Background with gradient overlay */
        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            background: linear-gradient(135deg, rgba(15, 45, 64, 0.05) 0%, rgba(21, 73, 103, 0.1) 100%);
            overflow: hidden;
        }
        
        .hero-image {
            width: 120%; /* Slightly larger */
            height: 120%; /* Slightly larger */
            object-fit: cover;
            opacity: 0.18; /* Slightly increased opacity */
            position: absolute;
            filter: saturate(115%); /* Enhance colors slightly */
        }
        
        /* Hero Logo */
        .hero-logo {
            display: none; /* Hide separate logo since background is sufficient */
        }
        
        /* Company tagline */
        .tagline {
            position: absolute;
            top: 5%; /* Position at top of page */
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-align: center;
            opacity: 0.9;
        }
        
        /* Login Container */
        .login-container {
            background-color: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color), 0 1px 3px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 480px; /* Slightly wider */
            padding: 45px 40px; /* More vertical padding */
            z-index: 3; /* Above the background */
            position: relative;
            border: 1px solid rgba(15, 45, 64, 0.05);
            backdrop-filter: blur(5px);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .login-header h1 {
            color: var(--primary-color);
            margin-bottom: 14px;
            font-weight: 600;
            font-size: 32px; /* Larger heading */
            letter-spacing: -0.5px;
        }
        
        .login-header p {
            color: var(--text-muted);
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 28px; /* More spacing between form groups */
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--primary-color);
            font-size: 15px;
        }
        
        .form-group input {
            width: 100%;
            padding: 16px; /* Larger input fields */
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }
        
        .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(15, 45, 64, 0.1);
            background-color: var(--bg-white);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 18px; /* Taller button */
            font-size: 17px; /* Larger font */
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 6px rgba(15, 45, 64, 0.1);
            margin-top: 10px; /* Add some space above button */
        }
        
        .btn-primary:hover {
            background-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(15, 45, 64, 0.15);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(15, 45, 64, 0.1);
        }
        
        .error-message {
            color: #e53e3e;
            background-color: #fed7d7;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 24px;
            font-size: 14px;
            display: none;
            border-left: 4px solid #e53e3e;
        }
        
        /* Footer */
        .footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            z-index: 2;
        }
    </style>
</head>
<body>
    <!-- Hero Background with gradient overlay -->
    <div class="hero-background">
        <img src="images/claim_connectors_blue_transparent.png" alt="Claim Connectors Logo" class="hero-image">
    </div>
    
    <!-- Company Tagline -->
    <div class="tagline">Connecting Claims with Justice</div>
    
    <!-- Login Container -->
    <div class="login-container">
        <div class="login-header">
            <h1>Welcome Back</h1>
            <p>Enter your credentials to access the dashboard</p>
        </div>
        
        <div id="error-message" class="error-message"></div>
        
        <form id="login-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" autocomplete="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" autocomplete="current-password" required>
            </div>
            
            <button type="submit" class="btn-primary">Log In</button>
        </form>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        &copy; 2023 Claim Connectors. All rights reserved.
    </div>

    <script>
        // Debug
        console.log('CryptoJS loaded:', typeof CryptoJS);
        console.log('AmazonCognitoIdentity loaded:', typeof AmazonCognitoIdentity);
    
        // Cognito configuration
        const cognitoConfig = {
            region: 'us-east-1',
            userPoolId: 'us-east-1_Lhc964tLD',
            clientId: '357mvn7k2nkjhl5nsq8h00o9tr',
            clientSecret: '7h6a92cinn7i5im0l0rpusuna0dpsqc4ha7f7nog0oocc318m46'
        };
        
        // Load from config if available
        fetch('config.json')
            .then(response => response.json())
            .then(config => {
                if (config.region) cognitoConfig.region = config.region;
                if (config.userPoolId) cognitoConfig.userPoolId = config.userPoolId;
                if (config.clientId) cognitoConfig.clientId = config.clientId;
                if (config.clientSecret) cognitoConfig.clientSecret = config.clientSecret;
                console.log('Configuration loaded');
            })
            .catch(error => {
                console.warn('Could not load config.json, using default configuration', error);
            });
        
        // Calculate the secret hash manually
        function calculateSecretHash(username) {
            try {
                console.log('Calculating SECRET_HASH for username:', username);
                // The message is username + clientId (in that order)
                const message = username + cognitoConfig.clientId;
                console.log('Message for SECRET_HASH:', message);
                
                // Create the HMAC-SHA256 of the message using the client secret as the key
                const hmac = CryptoJS.HmacSHA256(message, cognitoConfig.clientSecret);
                
                // Convert to Base64 as required by Cognito
                const secretHash = CryptoJS.enc.Base64.stringify(hmac);
                console.log('Generated SECRET_HASH:', secretHash);
                return secretHash;
            } catch (e) {
                console.error('Error calculating secret hash:', e);
                return null;
            }
        }
        
        // Handle login form submission
        document.getElementById('login-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get values and apply proper case handling
            let username = document.getElementById('username').value.trim();
            // For 'Admin' user, ensure first letter is capitalized
            if (username.toLowerCase() === 'admin') {
                username = 'Admin';
            }
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('error-message');
            
            console.log('Login attempt with username:', username);
            
            // Show error if fields are empty
            if (!username || !password) {
                errorMessage.textContent = 'Please enter both username and password';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Disable form during login
            const submitButton = this.querySelector('button[type="submit"]');
            const inputs = this.querySelectorAll('input');
            submitButton.textContent = 'Logging in...';
            submitButton.disabled = true;
            inputs.forEach(input => input.disabled = true);
            
            // Hide any previous error
            errorMessage.style.display = 'none';
            
            // Get the secret hash
            const secretHash = calculateSecretHash(username);
            
            // Create Cognito user pool
            const userPool = new AmazonCognitoIdentity.CognitoUserPool({
                UserPoolId: cognitoConfig.userPoolId,
                ClientId: cognitoConfig.clientId
            });
            
            // Use the CognitoIdentityServiceProvider approach - this is more reliable
            const authData = {
                Username: username,
                Password: password
            };
            
            if (secretHash) {
                authData.SecretHash = secretHash;
            }
            
            // Create the full parameter object for initiateAuth
            const authParameters = {
                AuthFlow: 'USER_PASSWORD_AUTH',
                ClientId: cognitoConfig.clientId,
                AuthParameters: authData
            };
            
            console.log('Authentication parameters:', JSON.stringify(authParameters));
            
            // Create Cognito user
            const cognitoUser = new AmazonCognitoIdentity.CognitoUser({
                Username: username,
                Pool: userPool
            });
            
            const authDetails = new AmazonCognitoIdentity.AuthenticationDetails({
                Username: username,
                Password: password,
                ValidationData: null,
                SecretHash: secretHash
            });
            
            // Explicitly override the client metadata
            cognitoUser.setClientMetadata({SecretHash: secretHash});
            
            // Try to authenticate
            try {
                cognitoUser.authenticateUser(authDetails, {
                    onSuccess: function(result) {
                        // Get tokens
                        const idToken = result.getIdToken().getJwtToken();
                        
                        // Store token in localStorage
                        localStorage.setItem('auth_token', idToken);
                        
                        // Extract user info
                        try {
                            const payload = result.getIdToken().decodePayload();
                            const userInfo = {
                                username: username,
                                role: payload['custom:role'] || payload['cognito:groups']?.[0] || 'agent',
                                name: payload.given_name && payload.family_name ? 
                                      `${payload.given_name} ${payload.family_name}` : username
                            };
                            localStorage.setItem('user', JSON.stringify(userInfo));
                        } catch (e) {
                            console.error('Error parsing user info:', e);
                            localStorage.setItem('user', JSON.stringify({ username, role: 'agent' }));
                        }
                        
                        // Redirect based on role
                        const user = JSON.parse(localStorage.getItem('user'));
                        window.location.href = user.role === 'admin' ? 'admin.html' : 'index.html';
                    },
                    onFailure: function(err) {
                        console.error('Authentication failed:', err);
                        errorMessage.textContent = err.message || 'Authentication failed. Please check your credentials.';
                        errorMessage.style.display = 'block';
                        
                        // Re-enable form
                        submitButton.textContent = 'Log In';
                        submitButton.disabled = false;
                        inputs.forEach(input => input.disabled = false);
                    }
                });
            } catch (e) {
                console.error('Error during authentication:', e);
                errorMessage.textContent = e.message || 'An error occurred during login.';
                errorMessage.style.display = 'block';
                
                // Re-enable form
                submitButton.textContent = 'Log In';
                submitButton.disabled = false;
                inputs.forEach(input => input.disabled = false);
            }
        });
    </script>
</body>
</html> 